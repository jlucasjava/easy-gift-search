const API_URL=window.location.hostname==="localhost"?"http://localhost:3000/api":"https://easy-gift-35cs.onrender.com/api";function showLoader(e){document.getElementById("loader").style.display=e?"block":"none"}function showMensagem(e,o=!1){const n=document.getElementById("mensagem");n.textContent=e,n.style.display=e?"block":"none",n.style.color=o?"#d32f2f":"#4e54c8"}function clearMensagem(){showMensagem("")}async function buscarProdutos(e={}){showLoader(!0),clearMensagem();try{const o=new URLSearchParams(e).toString(),n=await fetch(`${API_URL}/products?${o}`);if(!n.ok)throw new Error("Erro ao buscar produtos.");return await n.json()}catch(e){return showMensagem("Erro ao buscar produtos. Tente novamente.",!0),{produtos:[],pagina:1,totalPaginas:1}}finally{showLoader(!1)}}function renderSugestao(e,o=[],n=0,t=3){document.getElementById("sugestao").innerHTML=`<strong>${e}</strong>`;const r=document.getElementById("sugestaoProdutos");r.innerHTML="",o&&o.length?o.slice(n,n+t).forEach(e=>{const o=document.createElement("div");o.className="card",o.innerHTML=`\n        <img src="${e.imagem}" alt="${e.nome}" loading="lazy">\n        <h3>${e.nome}</h3>\n        <p>R$ ${e.preco}</p>\n        <a href="${e.url}" target="_blank">${t("ver_marketplace")}</a>\n        <button onclick="favoritarProduto('${e.id}', '${e.nome.replace(/'/g,"")}')">${t("favoritar")}</button>\n      `,r.appendChild(o)}):r.innerHTML=`<div style="grid-column:1/-1;text-align:center;color:#888;">${t("nenhum_produto")}</div>`}let sugestaoProdutos=[],sugestaoTexto="",sugestaoIndex=0;const SUGESTAO_LIMIT=3;async function recomendarPresente(e){showLoader(!0),clearMensagem();try{const o=await fetch(`${API_URL}/recommend`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!o.ok)throw new Error("Erro ao buscar sugest√£o.");return await o.json()}catch(e){return showMensagem("Erro ao buscar sugest√£o. Tente novamente.",!0),{sugestao:"",produtosRelacionados:[]}}finally{showLoader(!1)}}async function carregarRecomendacao(e=!1){const o=document.getElementById("idadeInput").value,n=document.getElementById("generoSelect").value,t={idade:o,genero:n};e&&(sugestaoIndex=0);const{sugestao:r,produtosRelacionados:a}=await recomendarPresente(t);sugestaoProdutos=a||[],sugestaoTexto=r||"",renderSugestao(sugestaoTexto,sugestaoProdutos,sugestaoIndex,3)}function renderGrid(e){const o=document.getElementById("grid");o.innerHTML="",e&&0!==e.length?(clearMensagem(),e.forEach((e=>{const t=document.createElement("div");t.className="card",t.innerHTML=`\n      <img src="${e.imagem}" alt="${e.nome}" loading="lazy">\n      <h3>${e.nome}</h3>\n      <p>R$ ${e.preco}</p>\n      <a href="${e.url}" target="_blank">Ver no marketplace</a>\n      <button onclick="favoritarProduto('${e.id}', '${e.nome.replace(/'/g,"")}')">Favoritar</button>\n    `,o.appendChild(t)}))):showMensagem("Nenhum produto encontrado para os filtros selecionados.")}function getFavoritos(){return JSON.parse(localStorage.getItem("favoritos")||"[]")}function setFavoritos(e){localStorage.setItem("favoritos",JSON.stringify(e))}function renderFavoritos(){const e=getFavoritos(),o=document.getElementById("gridFavoritos");o.innerHTML="",e.length?e.forEach((e=>{const t=document.createElement("div");t.className="card",t.innerHTML=`\n      <img src="${e.imagem}" alt="${e.nome}" loading="lazy">\n      <h3>${e.nome}</h3>\n      <p>R$ ${e.preco}</p>\n      <a href="${e.url}" target="_blank">Ver no marketplace</a>\n      <button onclick="removerFavorito('${e.id}')">Remover</button>\n    `,o.appendChild(t)})):o.innerHTML='<div style="grid-column:1/-1;text-align:center;color:#888;">Nenhum favorito ainda.</div>'}function renderPaginacao(e,o,t){const n=document.getElementById("paginacao");n.innerHTML="";for(let r=1;r<=o;r++){const o=document.createElement("button");o.textContent=r,r===e&&(o.disabled=!0),o.onclick=()=>carregarProdutos({...t,page:r}),n.appendChild(o)}}async function carregarProdutos(e={}){showLoader(!0);try{const{produtos:o,pagina:r,totalPaginas:a}=await buscarProdutos(e);renderGrid(o),renderPaginacao(r,a,e)}finally{showLoader(!1)}}async function carregarRecomendacao(){const e={idade:document.getElementById("idadeInput").value,genero:document.getElementById("generoSelect").value},{sugestao:o,produtosRelacionados:t}=await recomendarPresente(e);document.getElementById("sugestao").innerHTML=`\n    <strong>${o}</strong><br>\n    ${t?.map((e=>`<span>${e.nome} - R$ ${e.preco}</span>`)).join("<br>")||""}\n  `}function getHistoricoBuscas(){return JSON.parse(localStorage.getItem("historicoBuscas")||"[]")}function setHistoricoBuscas(e){localStorage.setItem("historicoBuscas",JSON.stringify(e))}function addHistoricoBusca(e){const o=getHistoricoBuscas(),t={...e},n=JSON.stringify(t);setHistoricoBuscas([t,...o.filter((e=>JSON.stringify(e)!==n))].slice(0,6))}function renderHistoricoBuscas(){const e=getHistoricoBuscas(),o=document.getElementById("listaHistorico");o&&(o.innerHTML="",e.length?(document.getElementById("historicoBuscas").style.display="",e.forEach(((e,t)=>{const n=document.createElement("button");n.className="tab-btn",n.style.fontSize="0.95rem",n.innerHTML=`#${t+1}: Pre√ßo ‚â• ${e.precoMin||"-"}, Idade: ${e.idade||"-"}, G√™nero: ${e.genero||"-"}`,n.onclick=()=>{carregarProdutos(e),carregarRecomendacao(!0)},o.appendChild(n)}))):document.getElementById("historicoBuscas").style.display="none")}window.favoritarProduto=function(e,o){const t=document.getElementById("grid"),n=Array.from(t.children).find((e=>e.querySelector("h3")?.textContent===o));if(!n)return;const r=n.querySelector("img")?.src,a=n.querySelector("p")?.textContent.replace("R$ ",""),s=n.querySelector("a")?.href,c=getFavoritos();if(c.some((o=>o.id===e)))return showMensagem(`Produto "${o}" j√° est√° nos favoritos!`),void setTimeout(clearMensagem,2e3);c.push({id:e,nome:o,preco:a,imagem:r,url:s}),setFavoritos(c),showMensagem(`Produto "${o}" adicionado aos favoritos!`),setTimeout(clearMensagem,2e3),renderFavoritos()},window.removerFavorito=function(e){let o=getFavoritos();o=o.filter((o=>o.id!==e)),setFavoritos(o),showMensagem("Produto removido dos favoritos!"),setTimeout(clearMensagem,2e3),renderFavoritos()},document.getElementById("searchForm").onsubmit=async e=>{e.preventDefault();const o={precoMin:document.getElementById("precoMin").value,idade:document.getElementById("idadeInput").value,genero:document.getElementById("generoSelect").value,page:1};addHistoricoBusca(o),renderHistoricoBuscas(),carregarProdutos(o),carregarRecomendacao(!0)};const btnVerResultados=document.getElementById("btnVerResultados"),btnVerFavoritos=document.getElementById("btnVerFavoritos"),secResultados=document.getElementById("produtos"),secFavoritos=document.getElementById("favoritos");btnVerResultados.onclick=()=>{secResultados.style.display="",secFavoritos.style.display="none",btnVerResultados.classList.add("active"),btnVerFavoritos.classList.remove("active")},btnVerFavoritos.onclick=()=>{secResultados.style.display="none",secFavoritos.style.display="",btnVerResultados.classList.remove("active"),btnVerFavoritos.classList.add("active"),renderFavoritos()},btnVerResultados.classList.add("active"),secFavoritos.style.display="none",renderFavoritos(),renderHistoricoBuscas(),carregarProdutos(),carregarRecomendacao(!0);const btnToggleDark=document.getElementById("toggleDark"),prefersDark=window.matchMedia("(prefers-color-scheme: dark)").matches;("true"===localStorage.getItem("darkMode")||!localStorage.getItem("darkMode")&&prefersDark)&&(document.body.classList.add("dark"),btnToggleDark.textContent="‚òÄÔ∏è"),btnToggleDark.onclick=()=>{const e=document.body.classList.toggle("dark");btnToggleDark.textContent=e?"‚òÄÔ∏è":"üåô",localStorage.setItem("darkMode",e)};