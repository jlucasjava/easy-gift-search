const API_URL="localhost"===window.location.hostname?"http://localhost:3000/api":"https://easy-gift-35cs.onrender.com/api";function showLoader(e){document.getElementById("loader").style.display=e?"block":"none"}function showMensagem(e,t=!1){const n=document.getElementById("mensagem");n.textContent=e,n.style.display=e?"block":"none",n.style.color=t?"#d32f2f":"#4e54c8"}function clearMensagem(){showMensagem("")}async function buscarProdutos(e={}){if(showLoader(!0),clearMensagem(),window.analyticsService){const t=e.query||"busca_geral",n={min_price:e.precoMin||null,max_price:e.precoMax||null,age:e.idade||null,gender:e.genero||null,page:e.page||1};window.analyticsService.trackSearch(t,n),e.precoMin&&window.analyticsService.trackFilterUsage("price_min",e.precoMin),e.precoMax&&window.analyticsService.trackFilterUsage("price_max",e.precoMax),e.idade&&window.analyticsService.trackFilterUsage("age",e.idade),e.genero&&window.analyticsService.trackFilterUsage("gender",e.genero)}try{const t=new URLSearchParams(e).toString(),n=await fetch(`${API_URL}/products?${t}`);if(!n.ok)throw new Error("Erro ao buscar produtos.");return await n.json()}catch(e){return window.analyticsService&&window.analyticsService.trackError("API_Error",e.message,"buscarProdutos"),showMensagem("Erro ao buscar produtos. Tente novamente.",!0),{produtos:[],pagina:1,totalPaginas:1}}finally{showLoader(!1)}}function renderSugestao(e,n=[],o=0,a=3){document.getElementById("sugestao").innerHTML=`<strong>${e}</strong>`;const r=document.getElementById("sugestaoProdutos");r.innerHTML="",n&&n.length?n.slice(o,o+a).forEach((e=>{const n=document.createElement("div");n.className="card",n.innerHTML=`\n        <img src="${e.imagem}" alt="${e.nome}" loading="lazy">\n        <h3>${e.nome}</h3>\n        <p>R$ ${e.preco}</p>\n        <a href="${e.url}" target="_blank" rel="noopener noreferrer">${t("ver_marketplace")}</a>\n        <button onclick="favoritarProduto('${e.id}', '${e.nome.replace(/'/g,"")}')">${t("favoritar")}</button>\n      `,r.appendChild(n)})):r.innerHTML=`<div style="grid-column:1/-1;text-align:center;color:#888;">${t("nenhum_produto")}</div>`}let sugestaoProdutos=[],sugestaoTexto="",sugestaoIndex=0;const SUGESTAO_LIMIT=3;async function recomendarPresente(e){showLoader(!0),clearMensagem();const t=Date.now();if(window.analyticsService){const t=`idade:${e.idade||"n√£o_informado"} genero:${e.genero||"n√£o_informado"}`;window.analyticsService.trackRecommendationRequest(t,null)}try{const n=await fetch(`${API_URL}/recommend`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!n.ok)throw new Error("Erro ao buscar sugest√£o.");const o=await n.json(),a=Date.now()-t;if(window.analyticsService){const t=`idade:${e.idade||"n√£o_informado"} genero:${e.genero||"n√£o_informado"}`,n=o.produtosRelacionados?o.produtosRelacionados.length:0;window.analyticsService.trackRecommendationResponse(t,n,a)}return o}catch(e){return window.analyticsService&&window.analyticsService.trackError("Recommendation_Error",e.message,"recomendarPresente"),showMensagem("Erro ao buscar sugest√£o. Tente novamente.",!0),{sugestao:"",produtosRelacionados:[]}}finally{showLoader(!1)}}async function carregarRecomendacao(e=!1){const t=document.getElementById("idadeInput").value,n=document.getElementById("generoSelect").value;e&&(sugestaoIndex=0),recomendarPresente({idade:t,genero:n}).then((({sugestao:e,produtosRelacionados:t})=>{sugestaoProdutos=t||[],sugestaoTexto=e||"",renderSugestao(sugestaoTexto,sugestaoProdutos,sugestaoIndex,3)}))}function mostrarMensagemInicial(){document.getElementById("grid").innerHTML=`\n    <div class="mensagem-inicial" style="grid-column:1/-1;text-align:center;padding:40px 20px;">\n      <h3 style="margin-bottom:20px;">üéÅ ${t("benvindo_titulo")}</h3>\n      <p style="margin-bottom:15px;font-size:16px;">${t("benvindo_descricao")}</p>\n      <p style="font-size:14px;opacity:0.8;">${t("benvindo_instrucoes")}</p>\n    </div>\n  `,document.getElementById("sugestao").innerHTML=`\n    <div style="text-align:center;font-style:italic;opacity:0.8;">\n      ${t("recomendacao_inicial")}\n    </div>\n  `}function renderGrid(e){const n=document.getElementById("grid");n.innerHTML="",e&&0!==e.length?(clearMensagem(),e.forEach(((e,o)=>{const a=document.createElement("div");a.className="card",a.innerHTML=`\n      <img src="${e.imagem}" alt="${e.nome}" loading="lazy">\n      <h3>${e.nome}</h3>\n      <p>R$ ${e.preco}</p>\n      <a href="${e.url}" target="_blank" onclick="trackProductClick('${e.id}', '${e.nome.replace(/'/g,"")}', ${e.preco}, '${e.marketplace}', ${o}, '${e.url}')">${t("ver_marketplace")}</a>\n      <button onclick="favoritarProduto('${e.id}', '${e.nome.replace(/'/g,"")}')">${t("favoritar")}</button>\n    `,window.analyticsService&&window.analyticsService.trackProductView(e.id,e.nome,e.preco,e.marketplace),n.appendChild(a)}))):showMensagem(t("nenhum_produto"))}function getFavoritos(){return JSON.parse(localStorage.getItem("favoritos")||"[]")}function setFavoritos(e){localStorage.setItem("favoritos",JSON.stringify(e))}function renderFavoritos(){const e=getFavoritos(),n=document.getElementById("gridFavoritos");n.innerHTML="",e.length?e.forEach((e=>{const o=document.createElement("div");o.className="card",o.innerHTML=`\n      <img src="${e.imagem}" alt="${e.nome}" loading="lazy">\n      <h3>${e.nome}</h3>\n      <p>R$ ${e.preco}</p>\n      <a href="${e.url}" target="_blank">${t("ver_marketplace")}</a>\n      <button onclick="removerFavorito('${e.id}')">${t("remover")}</button>\n    `,n.appendChild(o)})):n.innerHTML=`<div style="grid-column:1/-1;text-align:center;color:#888;">${t("nenhum_favorito")}</div>`}function renderPaginacao(e,t,n){const o=document.getElementById("paginacao");o.innerHTML="";for(let a=1;a<=t;a++){const t=document.createElement("button");t.textContent=a,a===e&&(t.disabled=!0),t.onclick=()=>carregarProdutos({...n,page:a}),o.appendChild(t)}}async function carregarProdutos(e={}){showLoader(!0);try{const{produtos:t,pagina:n,totalPaginas:o}=await buscarProdutos(e);renderGrid(t),renderPaginacao(n,o,e)}finally{showLoader(!1)}}async function carregarRecomendacao(){const e={idade:document.getElementById("idadeInput").value,genero:document.getElementById("generoSelect").value},{sugestao:t,produtosRelacionados:n}=await recomendarPresente(e);document.getElementById("sugestao").innerHTML=`\n    <strong>${t}</strong><br>\n    ${n?.map((e=>`<span>${e.nome} - R$ ${e.preco}</span>`)).join("<br>")||""}\n  `}window.trackProductClick=function(e,t,n,o,a,r){window.analyticsService&&(window.analyticsService.trackProductClick(e,t,n,o,a),window.analyticsService.trackConversion(e,t,n,o,r))},window.favoritarProduto=function(e,t){const n=document.getElementById("grid"),o=Array.from(n.children).find((e=>e.querySelector("h3")?.textContent===t));if(!o)return;const a=o.querySelector("img")?.src,r=o.querySelector("p")?.textContent.replace("R$ ",""),i=o.querySelector("a")?.href,c=getFavoritos();if(c.some((t=>t.id===e)))return showMensagem(`Produto "${t}" j√° est√° nos favoritos!`),void setTimeout(clearMensagem,2e3);c.push({id:e,nome:t,preco:r,imagem:a,url:i}),setFavoritos(c),showMensagem(`Produto "${t}" adicionado aos favoritos!`),setTimeout(clearMensagem,2e3),renderFavoritos()},window.removerFavorito=function(e){let t=getFavoritos();t=t.filter((t=>t.id!==e)),setFavoritos(t),showMensagem("Produto removido dos favoritos!"),setTimeout(clearMensagem,2e3),renderFavoritos()},document.getElementById("searchForm").onsubmit=async e=>{e.preventDefault();carregarProdutos({precoMin:document.getElementById("precoMin").value,precoMax:document.getElementById("precoMax").value,idade:document.getElementById("idadeInput").value,genero:document.getElementById("generoSelect").value,page:1}),carregarRecomendacao()};const btnVerResultados=document.getElementById("btnVerResultados"),btnVerFavoritos=document.getElementById("btnVerFavoritos"),secResultados=document.getElementById("produtos"),secFavoritos=document.getElementById("favoritos");btnVerResultados.onclick=()=>{secResultados.style.display="",secFavoritos.style.display="none",btnVerResultados.classList.add("active"),btnVerFavoritos.classList.remove("active")},btnVerFavoritos.onclick=()=>{secResultados.style.display="none",secFavoritos.style.display="",btnVerResultados.classList.remove("active"),btnVerFavoritos.classList.add("active"),renderFavoritos()},btnVerResultados.classList.add("active"),secFavoritos.style.display="none",renderFavoritos(),mostrarMensagemInicial();const btnToggleDark=document.getElementById("toggleDark"),prefersDark=window.matchMedia("(prefers-color-scheme: dark)").matches;function t(e){const t=localStorage.getItem("lang")||"pt";return window.I18N_STRINGS?.[t]?.[e]||e}if(("true"===localStorage.getItem("darkMode")||!localStorage.getItem("darkMode")&&prefersDark)&&(document.body.classList.add("dark"),btnToggleDark.textContent="‚òÄÔ∏è"),btnToggleDark.onclick=()=>{const e=document.body.classList.toggle("dark");btnToggleDark.textContent=e?"‚òÄÔ∏è":"üåô",localStorage.setItem("darkMode",e),window.analyticsService&&window.analyticsService.trackDarkModeToggle(e)},!localStorage.getItem("lang")){const e=navigator.language.startsWith("en")?"en":"pt";localStorage.setItem("lang",e)}const btnLang=document.createElement("button");function atualizarIdioma(e){const n=localStorage.getItem("lang");localStorage.setItem("lang",e),window.analyticsService&&n!==e&&window.analyticsService.trackLanguageChange(e,n),btnVerResultados.textContent=t("resultados"),btnVerFavoritos.textContent=t("favoritos"),document.getElementById("resultadosTitle").textContent=t("resultados"),document.getElementById("favoritosTitle").textContent=t("favoritos"),document.getElementById("recomendacaoTitle").textContent=t("recomendacao"),document.getElementById("precoMin").placeholder=t("preco_min"),document.getElementById("precoMax").placeholder=t("preco_max"),document.getElementById("idadeInput").placeholder=t("idade"),document.getElementById("generoSelect").options[0].text=t("genero"),document.getElementById("generoSelect").options[1].text=t("masculino"),document.getElementById("generoSelect").options[2].text=t("feminino"),document.getElementById("generoSelect").options[3].text=t("unissex"),document.getElementById("searchForm").querySelector('button[type="submit"]').textContent=t("buscar"),document.getElementById("historicoBuscas").querySelector("h3").textContent=t("historico"),renderFavoritos(),mostrarMensagemInicial(),btnLang.textContent="en"===e?"üáßüá∑":"üá∫üá∏"}btnLang.id="btnLang",btnLang.type="button",btnLang.style.position="absolute",btnLang.style.top="1.2rem",btnLang.style.right="3.8rem",btnLang.style.zIndex="10",btnLang.style.minWidth="40px",btnLang.style.minHeight="40px",btnLang.style.fontSize="1.3rem",btnLang.setAttribute("aria-label","Trocar idioma / Switch language"),btnLang.textContent="en"===localStorage.getItem("lang")?"üáßüá∑":"üá∫üá∏",document.body.appendChild(btnLang),btnLang.onclick=()=>{atualizarIdioma("en"===localStorage.getItem("lang")?"pt":"en")},document.addEventListener("DOMContentLoaded",(()=>{if(window.analyticsService){const e={language:localStorage.getItem("lang")||"pt",dark_mode_preference:"true"===localStorage.getItem("darkMode"),device_type:/Mobi|Android/i.test(navigator.userAgent)?"mobile":"desktop",browser:navigator.userAgent.includes("Chrome")?"Chrome":navigator.userAgent.includes("Firefox")?"Firefox":navigator.userAgent.includes("Safari")?"Safari":"Other",first_visit:!localStorage.getItem("analytics_visited"),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone};window.analyticsService.setUserProperties(e),localStorage.getItem("analytics_visited")||localStorage.setItem("analytics_visited","true"),window.addEventListener("load",(()=>{const e=performance.timing.loadEventEnd-performance.timing.navigationStart;window.analyticsService.trackPerformance("page_load_time",e,"ms")}))}}));